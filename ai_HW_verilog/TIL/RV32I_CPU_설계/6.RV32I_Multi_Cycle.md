# ğŸš²RV32I - Multi Cycle

## ğŸ§Multi-Cycle ì™œ ì“¸ê¹Œ

### ğŸ¢Single-Cycle

|                         Single-Cycle Path                         |
| :---------------------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/Sigle_Cycle_Critical_Path.png"> |

```mermaid
flowchart LR
PC --Address--> ROM
ROM --Instruction--> Register_File
Register_File --> ALU
ALU --> RAM
RAM --> Register_File
ROM --Instruction--> Contorl_Unit
Contorl_Unit --> Decoding
Decoding --> Signal_Out
Signal_Out --> ALU
```

- Single-Cycleì˜ ê²½ìš° 1clkì•ˆì— ëª…ë ¹ì„ ì²˜ë¦¬í•´ì•¼í•¨
- Combinational Logic Pathê°€ **ë§¤ìš° ê¸º**âš ï¸
- â­**Critical Path**ì—ì„œ ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ê³§ Clk Frequncyë¥¼ ê²°ì •í•¨
- **ì†ë„ê°€ ëŠë¦¬ë‹¤**

### ğŸ‡Multi-Cycle

|                    Multi-Cycle Stages                     |
| :-------------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/Multi_Cycle_Stage.png"> |

|      Step      |                          Description                          |
| :------------: | :-----------------------------------------------------------: |
|   **Fetch**    |          **PC** => **ROM**<br>ìˆ˜í–‰í•  ëª…ë ¹ì–´ë¥¼ ê°€ì ¸ì˜´          |
|   **Decode**   |                **Control Unit**<br>ëª…ë ¹ì–´ í•´ì„                |
|  **Execute**   |      **Data Path**<br>í•´ì„ëœ ëª…ë ¹ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì—°ì‚° ìˆ˜í–‰      |
| **Mem_Access** |              **RAM**<br>RAMì— ì ‘ê·¼(load/ store)               |
| **Write_back** | **RAM**<br>RAMìœ¼ë¡œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ Register Fileì— ì €ì¥(load) |

- ëª…ë ¹ì–´ ì—°ì‚° ìˆ˜í–‰ì„ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ”
- ê° Stageì‚¬ì´ì— Pipe register ì¡´ì¬
  - Combinational Logic Path ì¤„ì–´ë“¦
  - Clk Frequenyë¥¼ ë†’ì¼ ìˆ˜ ìˆë‹¤
- ëª…ë ¹ Typeë§ˆë‹¤ Stepì˜ ìˆ˜ê°€ ë‹¤ë¦„
  - ex) R, I Typeì€ Executeê¹Œì§€, L Typeì€ WBê¹Œì§€ ìˆ˜í–‰
  - ëª…ë ¹ íƒ€ì…ë³„ ì†Œëª¨ í´ëŸ­ ìˆ˜ë¥¼ ë‹¬ë¦¬í•  ìˆ˜ ìˆìŒ
  - í´ëŸ­ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬ ê°€ëŠ¥

ğŸ†šSingle-Cycle Vs Multi-Cycle
---
|     &nbsp;     | Single-Cycle |    Multi-Cycle    |
| :------------: | :----------: | :---------------: |
|   **Speed**    |     Slow     | Fast(than Single) |
| **Complexity** |     Easy     |       Hard        |

# ğŸ¨HW Design

## Stageë³„ ì—°ì‚° ì •ë¦¬

|      &nbsp;       |                               Image                               |
| :---------------: | :---------------------------------------------------------------: |
|  **Description**  |     <img src="./img/RV32I_Multi_Cycle/stageë³„_ì„¤ëª…_ìƒì„¸.png">     |
| **Block Diagram** | <img src="./img/RV32I_Multi_Cycle/Multi_Cycle_Stage_Diagram.png"> |

- ê° Stageì— í•´ë‹¹í•˜ëŠ” HW êµ¬ê°„ì„ ë‚˜ëˆ”
- ë‹¤ìŒ Stageë¡œ ë„˜ì–´ê°€ê¸° ì „, Registerë¥¼ ê±°ì³ì„œ ë‚˜ê°
  - ì´ì „ Stageê°€ ëë‚˜ê¸°ì „ê¹Œì§€ ëŒ€ê¸° í•„ìš”
  - Registerë¡œ ì¡°ì ˆ

â˜¸ï¸FETCH
---

### PC
- ê¸°ì¡´ì— 1Clkë§ˆë‹¤ ëª…ë ¹ì–´ ì²˜ë¦¬
- Multi-Cycleì—ì„œëŠ” ëª…ë ¹ì–´ íƒ€ì…ë³„ë¡œ ì†Œëª¨ í´ëŸ­ ìˆ˜ê°€ ë‹¤ë¦„
  - â—ë§¤ í´ëŸ­ë§ˆë‹¤ PCë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ë©´ ì•ˆë¨
  - PC_En ì‹ í˜¸ë¡œ ì¡°ì ˆ

ğŸ—ï¸Decode
---
- **Control Unit**ì—ì„œ Instruction Codeë¥¼ í•´ì„í•˜ì—¬ ì œì–´ì‹ í˜¸ ì¶œë ¥
- Register Fileì˜ ì¶œë ¥ì€ Decode Stageì—ì„œ ëŒ€ê¸° í•„ìš”
  - Reegisterë¥¼ ë‘ì–´ 1clk ëŠ¦ì¶¤

ğŸ§®Execute
---
- **ALU** ë° ì—°ì‚° ë¡œì§ì—ì„œ Control Unitì—ì„œ ë°›ì€ ì œì–´ì‹ í˜¸ë¥¼ í† ëŒ€ë¡œ ì—°ì‚° ìˆ˜í–‰ ì‹œì‘
- ë‹¤ìŒ Stageì¸ RAMì— ì ‘ê·¼í•˜ê¸° ì „ì—, 1Clk ëŒ€ê¸° í•„ìš”
  - Pipe Registerë¥¼ ë‘ 

ğŸ“‚Memory Access
---
- RAMì— ì ‘ê·¼í•˜ì—¬, Register Fileì—ì„œì˜ Dataë¥¼ ì €ì¥í•¨
- Read Dataì˜ ê²½ìš° Write Backì´ ìˆ˜í–‰ë˜ê¸° ì „ê¹Œì§€ ëŒ€ê¸° í•„ìš”
  - Registerë¥¼ ë‘ì–´ 1Clk ëŒ€ê¸°

âœï¸Write Back
---
- RAMì—ì„œ ì½ì–´ì˜¨ Data(Read Data)ë¥¼ Register Fileì— ì €ì¥í•¨

# ğŸ”Simulation ê²€ì¦

## âœ”ï¸Simulation Verification
> ëª¨ë“  Caseë¥¼ ê²€ì¦í•˜ì˜€ìœ¼ë‚˜, ê¸°ë¡ì€ íŠ¹ìˆ˜ Caseì— ëŒ€í•´ì„œë§Œ í•˜ì˜€ë‹¤

## 1. R-Type

### SRA & SRL

|                   Simulation Result                    |
| :----------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/SRA_SRL_R_Type.png"> |

|    &nbsp;    | Test_Vector | Shift_Value |     SRA     |     SRL     |
| :----------: | :---------: | :---------: | :---------: | :---------: |
| **Register** |     X1      |     X3      |     X4      |     X5      |
|  **Value**   | 0xF000_0000 |     0x4     | 0xFF00_0000 | 0x0F00_0000 |

### SLT & SLTU

|                    Simulation Result                    |
| :-----------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/SLT_SLTU_R_Type.png"> |

|    &nbsp;    |             Test_Vector             | ë¹„êµ ëŒ€ìƒ |  SLT  | SLTU  |
| :----------: | :---------------------------------: | :-------: | :---: | :---: |
| **Register** |                 X1                  |    X0     |  X6   |  PC   |
|  **Value**   | Signed: -8<br>Unsigned: 42944967288 |    0x0    |  0x1  |  0x0  |


## 2. I-Type

### SRAI & SRLI

|                 Simulation Result                  |
| :------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/i_Typeê²€ì¦.png"> |

|    &nbsp;    | Test_Vector | Immediate Value |    SRAI     |    SRLI     |
| :----------: | :---------: | :-------------: | :---------: | :---------: |
| **Register** |     X1      |       Imm       |     X6      |     X7      |
|  **Value**   | 0xF000_0000 |       0x8       | 0xFFF0_0000 | 0x00F0_0000 |

## 3. B-Type

|                Simulation Result                 |
| :----------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/BLTU_BLT.png"> |

|    &nbsp;    |             Test_Vector             | ë¹„êµê°’ | Immediate Value |  ì´ˆê¸° PC   | BLTU  |  BLT  |
| :----------: | :---------------------------------: | :----: | :-------------: | :--------: | :---: | :---: |
| **Register** |                 X1                  |   X0   |       Imm       | Initial PC |  PC   |  PC   |
|  **Value**   | Signed: -16<br>Unsigned: 4294967280 |  0x0   |       12        |     20     |  24   |  36   |

## 4. LU/AU-Type

|                 Simulation Result                  |
| :------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/LU_AU_ê²€ì¦.png"> |

|    &nbsp;    | Immediate Value |  LUI  | Befor AU PC |     AUI     |
| :----------: | :-------------: | :---: | :---------: | :---------: |
| **Register** |       Imm       |  X5   |     PC      |     X5      |
|  **Value**   |    0x1000_0     | 0x2C  | 0x8000_0000 | 0x8000_002C |

## 5. J/JL-Type

|                 Simulation Result                 |
| :-----------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/J_JL_Type.png"> |

|      &nbsp;      | Retrun Address |   PC   |
| :--------------: | :------------: | :----: |
|   **Register**   |     **X1**     | **PC** |
| **J_Before_PC**  |       XX       |   16   |
|  **J_After_PC**  |       20       |   28   |
| **JL_Before_PC** |       20       |   28   |
| **JL_After_PC**  |       32       |   16   |

## 6. L/S Type

### SW/LW

|                 Simulation Result                  |
| :------------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/LW_SW_ê²€ì¦.png"> |

```mermaid
flowchart LR

A[X31 Reg] --SW--> B["RAM[0]"]
B --LW--> C[X23]

```

### LB

|                Simulation Result                |
| :---------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/LB_ê²€ì¦.png"> |

|   &nbsp;   |             Data              |
| :--------: | :---------------------------: |
| **RAM[0]** |          0x3322_11FF          |
|  **X15**   | 0xFFFF_FFFF<br>Sign Extension |
|  **X16**   |             0x11              |
|  **X17**   |             0x22              |
|  **X18**   |             0x33              |

### SB

|                Simulation Result                |
| :---------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/SB_ê²€ì¦.png"> |

|      &nbsp;       |    Data     |
| :---------------: | :---------: |
|      **X31**      | 0x3322_11FF |
| **RAM[0]:1st SB** | 0xXXXX_XXFF |
| **RAM[0]:2nd SB** | 0xXXXX_11FF |
| **RAM[0]:3rd SB** | 0xXX22_11FF |
| **RAM[0]:4th SB** | 0x3322_11FF |

### LH

|                Simulation Result                |
| :---------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/LH_ê²€ì¦.png"> |

|   &nbsp;   |    Data     |
| :--------: | :---------: |
|  **X31**   | 0x3322_11FF |
| **RAM[0]** | 0x3322_11FF |
|  **X19**   |   0x11FF    |
|  **X20**   |   0x3322    |

### SH

|                Simulation Result                |
| :---------------------------------------------: |
| <img src="./img/RV32I_Multi_Cycle/SH_ê²€ì¦.png"> |

|       &nbsp;       |    Data     |
| :----------------: | :---------: |
|      **X31**       | 0x3322_11FF |
| **RAM[2]: 1st SH** | 0xXXXX_11FF |
| **RAM[2]: 2nd SH** | 0x3322_11FF |

# ğŸš€Trouble Shooting

## 1ï¸âƒ£Store Value Decision Module
- Store Value Decisionì€ RAMì— ì“¸ ì£¼ì†Œì˜ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ì½ì–´ì™€ì„œ ì €ì¥í•  ë°ì´í„° ë¶€ë¶„ì„ êµì²´í•¨
- Multy-Cycleì˜ ê²½ìš°
  - S_Executeì—ì„œ Storeí•  ë°ì´í„°ë¥¼ êµì²´í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•¨
  - ì´ ë•Œ, Executeë‹¨ê³„ì—ì„œ ```ALU```ì—ì„œ ì—°ì‚°ëœ ì£¼ì†Œì˜ RAM ë°ì´í„°ë¥¼ ì½ì–´ì™€ì•¼í•¨
  - â—ê·¸ëŸ¬ë‚˜ Multi-Cycleë¡œ ë°”ê¾¸ë©´ì„œ RAM address ì…ë ¥ë¶€ì— Registerë¥¼ ë‘ 
  - â­Executeë‹¨ê³„ì—ì„œ ì—°ì‚°ëœ ì£¼ì†Œì˜ Dataë¥¼ ì½ì–´ì™€ì•¼í•˜ì§€ë§Œ Registerë¡œ ì¸í•´ ì´ì „ ì£¼ì†Œì˜ ë°ì´í„°ë¥¼ ì½ì–´ì˜´
    - ì—‰ëš±í•œ ì£¼ì†Œì˜ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” ë¬¸ì œì 
- RAM ë°ì´í„° ë°”ë¡œ ì½ì–´ì„œ í•´ê²°(ë ˆì§€ìŠ¤í„° ì¶œë ¥ì„ ì½ì–´ì˜¤ì§€ ì•ŠìŒ)

## 2ï¸âƒ£Memory Multiple Driving Problem(Register File)

### Vivadoì—ì„œ ì½”ë“œ
```verilog
    initial begin  // for simulation test
        for (int i = 0; i < 32; i++) begin
            mem[i] = 10 + i;
        end
        mem[31] = 32'h3322_11ff;
        mem[1]  = 32'h0000_0004;
        mem[2]  = 32'h0000_0008;
    end

    always_ff @(posedge clk) begin
        if (we) mem[WA] <= WD;
    end
```
- ê¸°ì¡´ Vivadoì—ì„œ Simulationì„ ìœ„í•´ Register Fileì˜ ì¼ë¶€ ì£¼ì†Œì— ë°ì´í„°ë¥¼ ```initial```ì„ ì´ìš©í•´ ë„£ì–´ì¤Œ
- Vivadoì—ì„œëŠ” ```always``` blockê³¼ ```initial``` blockì—ì„œ ë™ì‹œì— Memoryì— writeë¥¼ í•´ë„ ë¬¸ì œX
- **VCS Verdi**
  - Multiple Drive Error ë°œìƒâ—
  - CoderëŠ” ```always```ì™€ ```initial```ì—ì„œ ë™ì‹œì— memoryì˜ ë™ì¼ ì£¼ì†Œì— ì ‘ê·¼í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì„ ì•
  - **Compiler** ì…ì¥ì—ì„œëŠ” ì´ ì‚¬ì‹¤ì„ ì•Œì§€ ëª»í•¨
  - ê·¸ë˜ì„œ initialì—ì„œ ì´ˆê¸°ê°’ì„ ì£¼ì§€ì•Šê³ , always ë¬¸ì•ˆì— ```reset```ì´ ë“¤ì–´ì˜¬ ë•Œ, ì´ˆê¸°ê°’ì„ ì„¸íŒ…í•´ì¤Œ

### ìˆ˜ì • í›„ ì½”ë“œ(in VCS Verdi)
```verilog
    always_ff @(posedge clk) begin
        if(test_reset) begin
            for (int i = 0; i < 32; i++) begin
            mem[i] = 10 + i;
        end
        mem[31] = 32'h3322_11ff;
        mem[1]  = 32'h0000_0004;
        mem[2]  = 32'h0000_0008;
        end
        else if (we) mem[WA] <= WD;
    end
```